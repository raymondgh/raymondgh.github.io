<!DOCTYPE html>
<meta charset="UTF-8">
<body>
	open the console
</body>
<script>


//////////////////////
// Signaling Server //
//////////////////////

// keep track of who the server knows about
let listOfPeers = ['Peer1', 'Peer2'];

// make sure signal won't crash the server
function parseSignal(rawSignal) {

	try {
		// parse the message as json (or at least try)
		let message = JSON.parse(rawSignal);

		// assuming we got json, make sure the destination is set as a peer on our list
		if (listOfPeers.includes(message.destination)) {

			// if destination is valid, let's dispatch it!
			processSignal(message);

		} else {

			// if destination not on list, let's just give up on this message :(
			console.log("SERVER: Uh oh, that destination isn't on our peer list. Let's just throw this message away!");
		}

	} catch(error) {

		// something failed earlier. probably parsing the json went poorly
		console.log("SERVER: Uh oh, we got a message that we couldn't parse. Let's just throw this message away!");
		console.log("But first, here's the error:", error);

	}
}


// signal is good enough to send, so now we stringify & send it!
function processSignal(message) {

	let payload = JSON.stringify(message);
	
	// simulate sending the message from server to client.
	switch (message.destination) {

		// these functions are how the peer handles signals from the server
		case 'Peer1':
			peer1SignalHandler(payload);
			break;
		case 'Peer2':
			peer2SignalHandler(payload);
			break;
		default:
			console.log("SERVER: Weird, a message was sent to the server and got past the validation but still has nowhere to go! Oh well.")
			console.log("Here's what it was:", message);
			break;
	}
}




////////////
// Peer 1 //
////////////

// begin by creating an RTCPeerConnection
let peer1connection = new RTCPeerConnection();

// we need a data channel (as opposed to video or audio) for this demo!
let peer1datachannel = peer1connection.createDataChannel('myFirstDataChannel')

// now let's create an offer to send to peer2
peer1connection.createOffer().then((OfferRTCSessionDescription) => {

	// peer1, the offerer, will set the offer to be its Local Description
	// setting Local Description triggers the peer1connection.onicecandidate event!!
	peer1connection.setLocalDescription(OfferRTCSessionDescription);

	// Prepare a message to send to peer 2
	let message = {	source: 'Peer1',
					destination: 'Peer2',
					messageType: 'data-offer',
					sessionDescription: OfferRTCSessionDescription
				};

	// send OfferRTCSessionDescription to peer2 via signaling server
	peer1SendMessageViaSignalingServer(message);
})


// function peer1 uses to pass messages to signaling server 
function peer1SendMessageViaSignalingServer(message) {

	// convert to string to send over our pretend network
	let payload = JSON.stringify(message)

	// server receives payload string. wow what great connection speed!
	parseSignal(payload);
}


// handle the onicecandidate events generated by setting of local description
peer1connection.onicecandidate = event => {

	// prepare a message to send to peer 2
	let message = { source: 'Peer1',
					destination: 'Peer2',
					messageType: 'ice-candidate',
					candidate: event.candidate
				};

	peer1SendMessageViaSignalingServer(message);
}



// when the signaling server sends something to peer1, parse it and react
function peer1SignalHandler(signal) {

	message = JSON.parse(signal);

	switch (message.messageType) {

		case 'data-answer':
			// handle data offer
			peer1HandleDataAnswer(message);
			break;
		case 'ice-candidate':
			//handle ice candidate
			peer1HandleIceCandidate(message);
			break;
		default:
			console.log("PEER 1: We got something from the server but we don't know what it is!");
			console.log("Take a look for yourself:", signal);
	}
}


// handle ice candidate delivered by signal server from peer 2
function peer1HandleIceCandidate(message) {

	// get the candidate from the message
	let candidate = message.candidate;

	// add the ice candidate to the connection
	peer1connection.addIceCandidate(candidate).then(() =>

		// it worked!
		() => console.log('PEER 1: Yay, we added a candidate.'),

		// it didn't work!
		err => {
			console.log('PEER 1: Oh no! We failed to add the candidate');
			console.log("Here's the error:", err);
		});
}


// handle data offer delivered by signal server
function peer1HandleDataAnswer(message) {

	// set the remote description as the offer session description
	peer1connection.setRemoteDescription(message.sessionDescription);
}




// some data channel handlers for peer 1
peer1datachannel.onopen = event => {
	console.log("PEER 1: Hey, my data channel was opened!");
	console.log("Use the command peer1datachannel.send() to send something to Peer 2");
}

peer1datachannel.onclose = event => {
	console.log("PEER 1: Hey, my data channel was closed!");
}

peer1datachannel.onmessage = event => {
	console.log("PEER 1: Hey, I just got this message:");
	console.log(event.data);
}



////////////
// Peer 2 //
////////////

let peer2connection = new RTCPeerConnection();

let peer2datachannel;

// when the signaling server sends something to peer2, parse it and react
function peer2SignalHandler(signal) {

	message = JSON.parse(signal);

	switch (message.messageType) {

		case "data-offer":
			// handle data offer
			peer2HandleDataOffer(message);
			break;
		case 'ice-candidate':
			//handle ice candidate
			peer2HandleIceCandidate(message);
			break;
		default:
			console.log("PEER 2: We got something from the server but we don't know what it is!");
			console.log("Take a look for yourself:", signal);
	}
}


// handle data offer delivered by signal server
function peer2HandleDataOffer(message) {

	// set the remote description as the offer session description
	peer2connection.setRemoteDescription(message.sessionDescription);

	// create an answer to send back to peer 1 via the signaling server
	peer2connection.createAnswer().then((AnswerRTCSessionDescription) => {

		// set the localdescription as the answer
		// setting Local Description triggers the peer2connection.onicecandidate event!!
		peer2connection.setLocalDescription(AnswerRTCSessionDescription);


		// Prepare a message to send to peer 2
		let message = {	source: 'Peer2',
						destination: 'Peer1',
						messageType: 'data-answer',
						sessionDescription: AnswerRTCSessionDescription
					};

		// send AnswerRTCSessionDescription to peer1 via signaling server
		peer2SendMessageViaSignalingServer(message)

	});
}


// handle ice candidate delivered by signal server from peer 1
function peer2HandleIceCandidate(message) {

	// get the candidate from the message
	let candidate = message.candidate;

	// add the ice candidate to the connection
	peer2connection.addIceCandidate(candidate).then(() =>

		// it worked!
		() => console.log('PEER 2: Yay, we added a candidate.'),

		// it didn't work!
		err => {
			console.log('PEER 2: Oh no! We failed to add the candidate');
			console.log("Here's the error:", err);
		});
}


// handle the onicecandidate events generated by setting of local description
peer2connection.onicecandidate = event => {

	// prepare a message to send to peer 2
	let message = { source: 'Peer2',
					destination: 'Peer1',
					messageType: 'ice-candidate',
					candidate: event.candidate
				};

	peer2SendMessageViaSignalingServer(message);
}



// function peer2 uses to pass messages to signaling server 
function peer2SendMessageViaSignalingServer(message) {

	// convert to string to send over our pretend network
	let payload = JSON.stringify(message)

	// server receives payload string. wow what great connection speed!
	parseSignal(payload);
}

// once data channel is created by peer1, peer2 should do something about it
peer2connection.ondatachannel = event => {

	// create data channel object for peer 2
	peer2datachannel = event.channel;


	// some data channel handlers for peer 1
	peer2datachannel.onopen = event => {
		console.log("PEER 2: Hey, my data channel was opened!");
		console.log("Use the command peer2datachannel.send() to send something to Peer 1");
	}

	peer2datachannel.onclose = event => {
		console.log("PEER 2: Hey, my data channel was closed!");
	}

	peer2datachannel.onmessage = event => {
		console.log("PEER 2: Hey, I just got this message:");
		console.log(event.data);
	}


}

</script>
</html>